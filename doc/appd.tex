% $Id$
% Copyright (c) 2000  The PARI Group
%
% This file is part of the PARI/GP documentation
%
% Permission is granted to copy, distribute and/or modify this document
% under the terms of the GNU General Public License
\appendix{PARI and threads}

To use PARI in multi-threaded programs, you must configure it using
\kbd{Configure --enable-tls}. Your system must implement the \kbd{\_\_thread}
storage class. As a major side effect, this breaks the \kbd{libpari} ABI: the
resulting library binary is not compatible with the old one, and
\kbd{-tls} is appended to PARI library SONAME.

On the other hand, it will be thread-safe. In this model, each concurrent
threads needs its own PARI stack.

PARI provides some functions to set up functional PARI subthreads\sidx{threads}.
The following schema is used:

Parent thread:
\bprog
  pthread_t th;
  struct pari_thread pth;
  GEN data, result;
...
  pari_thread_alloc(&pth,s,data);
  pthread_create(&th,NULL, &child_thread, (void*)&pth);
...
  pthread_join(th,(void*)&result);
  /* Copy result from thread stack to main stack */
  result = gcopy(result);
  pari_thread_free(&pth);
@eprog

Child thread:
\bprog
void *
child_thread(void *arg)
{
  GEN data = pari_thread_start((struct pari_thread*) arg);
  GEN result;
...
  /* Compute result from data */
...
  pari_thread_close();
  return (void*)result;
}
@eprog

\fun{void}{pari_thread_alloc}{struct pari_thread *pth, size_t s, GEN arg}
Allocate a PARI stack of size \kbd{s} and associated it, together with the
argument \kbd{arg}, with the PARI thread data \kbd{pth}.

\fun{void}{pari_thread_free}{struct pari_thread *pth}
Free the PARI stack associated with the PARI thread data \kbd{pth}.
Any \kbd{GEN} objects returned by the thread in the thread stack need to be
saved before running this command.

\fun{void}{pari_thread_init}{void}
Initialize the thread-local PARI data structures.
This function is called by \kbd{pari\_thread\_start}.

\fun{GEN}{pari_thread_start}{struct pari_thread *t}
Initialize the thread-local PARI data structures and
set up the thread stack using the PARI thread data \kbd{pth}.
This function returns the thread argument that was given to
\kbd{pari\_thread\_alloc}.

\fun{void}{pari_thread_close}{void}
Free the thread-local PARI data structures, including clones. Any \kbd{GEN}
objects returned by this thread need to stored in the thread stack.

%\fun{void}{pari_stack_alloc}{struct pari_stack *st, size_t s}
%\fun{void}{pari_stack_free}{struct pari_stack *st}
%\fun{void}{pari_stack_use}{struct pari_stack *st}

\noindent Under this model, some PARI states are reset in new threads. In
particular

\item the random number generator is reset to the starting seed;

\item the system stack exhaustion checking code, meant to catch infinite
recursions, is disabled (use \kbd{pari\_stackcheck\_init()} to reenable it);

\item cached real constants (returned by \kbd{mppi}, \kbd{mpeuler} and
\kbd{mplog2}) are not shared between threads and will be recomputed as
needed;

\item error handlers (set with \kbd{trap()}) are reset.

\noindent The following sample program can be compiled using
\bprog
    cc thread.c -o thread.o -lpari -lpthread
@eprog\noindent
(Add \kbd{-I/-L} paths as necessary.)

\noindent\bprogfile{../examples/thread.c}

\vfill\eject
