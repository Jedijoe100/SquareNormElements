% $Id$
% Copyright (c) 2000  The PARI Group
%
% This file is part of the PARI/GP documentation
%
% Permission is granted to copy, distribute and/or modify this document
% under the terms of the GNU General Public License
\appendix{PARI and threads}

To use PARI in multi-threaded programs, you must configure it using
\kbd{Configure --enable-tls}. Your system must implement the \kbd{\_\_thread}
storage class. As a major side effect, this breaks the \kbd{libpari} ABI: the
resulting library will not be compatible with the old one. On the other hand,
it now provides the following two public functions\sidx{threads}

\fun{void}{pari_thread_init}{size\_t parisize} must be called when starting a
thread: it allocates a local stack of size \kbd{parisize} and local cached
universal constants (e.g. \kbd{Pi}, \kbd{Euler}). Here, \emph{local} means
\emph{local to the present thread}.

\fun{void}{pari_thread_close}{void} must be called when closing a thread,
and deallocates the above resources.

Under this model, some PARI states are reset in new threads. In particular

\item the random number generator is reset to the starting seed;

\item the system stack exhaustion checking code is disabled (use
\kbd{pari\_stackcheck\_init()} to reenable it);

\item cached real constants (returned by \kbd{mppi, mpeuler and mplog2}) are not
shared between threads and will be recomputed as needed;

\item error handlers (set with \kbd{trap()}) are reset.

\noindent The following sample program can be compiled using
\bprog
    cc thread.c -o thread.o -lpari -lpthread
@eprog\noindent
(Add \kbd{-I/-L} paths as necessary.)

\noindent\bprogfile{../examples/thread.c}

\vfill\eject
