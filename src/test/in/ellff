test(p,n=0,v='a,w=1)=
{
  my(a=if(n,ffgen(ffinit(p,n),v),p));
  my(E=ellffinit([w,1,1-w,0,a+3],a));
  my(G=ellgenerators(E)[1]);
  my(P=random(E));
  [d1]=ellgroup(E);
  if(ellorder(E,G)!=d1,error([p,n,0]));
  if(ellpow(E,G,d1)!=[0],error([p,n,1]));
  if(ellpow(E,P,d1)!=[0],error([p,n,2]));
  if(d1%ellorder(E,P)!=0,error([p,n,3]));
  if (d1<10^7,
    P=ellpow(E,G,1023);
    if(elllog(E,P,G)!=1023%d1,error([p,n,4]));
  );
}
test(2,0);
test(2,78);
test(2,100);
test(2,101,,0);
test(3,0,,0);
test(3,50,,0);
test(3,51,,1);
test(5,0);
test(5,3);
test(7,3);
test(11,2);
test(17,2);
test(1009,3);
test(1013,7);
test(1009,11,'x);
test(17);
test(41);
test(1073741827);
test(nextprime(2^65),2);

a=ffgen(ffinit(101,3),'a);
E=ellffinit([1,3],a); E.j
E.disc
P=random(E);Q=random(E);
R=elladd(E,P,Q);
elladd(E,ellsub(E,R,P),ellneg(E,Q))

check(a)=
{
  my(E,P,N);
  E=ellffinit([1,0,0,0,a],a,1);
  N=ellcard(E);
  for(i=1,4,
    P=random(E);
    if(ellpow(E,P,N)!=[0],error(a)));
  ellgenerators(E);
}
{
  for(a=1,8,
    g = ffprimroot(ffgen(ffinit(2,a),'t));
    for(i=0,2^a-2, check(g^i)));
  for(a=1,6,
    g = ffprimroot(ffgen(ffinit(3,a),'t));
    for(i=0,3^a-2, check(g^i)));
}
