# Exported variables
_dlld_list='DLLD DLLDFLAGS EXTRADLLDFLAGS DLSUFFIX soname sodest'

# Which suffix for Dynamic Lib?
# Some linkers (SunOS 4) need minor and major lib version numbers.
# Some others (SunOS 5) need a link from a .so
# Some others (HPUX 09) do not want version numbers.
DLSUFFIX=so
soname=.$soname_num
do_dll=yes
case "$osname-$arch" in
  osf1-*|solaris-*|linux-*|freebsd-*)
    case $libpari_base in
      pari) sodest=.$version.$patch;; # released version
      *)    sodest=.$patch.0.0;;      # unstable version
    esac ;;
  sunos-*) sodest=.$VersionMajor$VersionMinor.$patch
           soname=$sodest;;
  hpux-*) soname= ; sodest= ; DLSUFFIX=sl;;
  irix-*) soname= ; sodest= ;;
  os2-*)  soname= ; sodest= ; DLSUFFIX=dll
          libpari_base=`echo "$libpari_base" | sed 's/\./_/g'` # 8.3 DLL name
       ;;
#  aix-*)  DLSUFFIX=a ;; FIXME: dynamic linking does not work
# cygwin-*)soname= ; sodest= ; DLSUFFIX=dll ;; FIXME: gp-dyn.exe crashes
  *) do_dll=no ;;
esac

# if DLLD is defined at this point, respect it, even if do_dll=no
if test $do_dll=yes -a -z "$DLLD"; then
  if test -n "$__gnuc__" -o "$osname"=solaris; then
    DLLD="$CC"
  else
    DLLD=$ld # don't take risks
  fi
fi

GNUdlld=
DLLDneedsWl=
if test -n "$DLLD"; then
# Which Dynamic Lib Linker?
  if test "$fastread" != yes; then
    echo $n ..."Which linker for building dynamic libs? $c"
    dflt="$DLLD"; rep=; . ./myread
    DLLD=$ans
  fi

  if test "$DLLD"="$CC"; then
    if test -n "$__gnuc__"; then
      DLLDneedsWl=yes;
      GNUdlld=$GNULDused
    fi 
  fi

  case "$DLLD" in
    *ld) if ($DLLD -v 2>&1 | grep GNU > /dev/null); then GNUdlld=yes; fi;;
  esac

# Which Flags for Dynamic Lib Linker ?
  if test -n "$GNUdlld"; then
    DLLDFLAGS="-shared -soname=\$(LIBPARI_SONAME)"
  else # DLLD != GNU ld
    case "$osname" in
      aix)     DLLDFLAGS="-r" ;;
      hpux)    DLLDFLAGS="-b -E" ;;
      freebsd) DLLDFLAGS="-Bshareable -x" ;;
      linux)   DLLDFLAGS="-shared -soname=\$(LIBPARI_SONAME)" ;;
      irix)    DLLDFLAGS="-shared -elf -no_unresolved -all" ;;
      osf1)    case "$optimization" in
                   full) DLLDFLAGS="-shared -O3" ;;
                   *)    DLLDFLAGS="-shared" ;;
                 esac;;
      sunos)   DLLDFLAGS="-assert nodefinitions" ;;
      solaris) DLLDFLAGS="-G -h \$(LIBPARI_SONAME)" ;;
      os2)     ;; # see below
      *)         DLLD=;;
    esac
  fi
  case "$osname" in
    osf1|freebsd|linux|sunos|solaris) EXTRADLLDFLAGS='-lc ${LIBS}';;
  esac
  DLLDFLAGS=`./ldflags "$DLLDneedsWl" "$DLLDFLAGS"`
  # assume DLLD = djgpp
  case "$osname" in
    os2) case "$optimization" in
           full) DLLDFLAGS="$CFLAGS -Zdll -s" ;;
           *)    DLLDFLAGS="$CFLAGS -Zdll" ;;
         esac;;
  esac

  if test "$fastread" != yes; then
    echo $n ..."Which flags for linker? $c"
    dflt=$DLLDFLAGS; rep=; . ./myread
    DLLDFLAGS=$ans
  fi
fi

if test -z "$DLLD"; then
  echo "No Dynamic Lib"
else
  echo "Dynamic Lib linker is  $DLLD  $DLLDFLAGS"
  if test -n "$GNUdlld"; then
    echo "...Hum, this looks like GNU ld"
  fi
fi
